!!! 5
html
  head
    title teh swaharm dehmo

    link(rel='stylesheet', type="text/css", media="screen, projection", href='/screen.css' )

    script(src='http://api.bugswarm-dev/socket.io/socket.io.js')
    script(src='http://maps.google.com/maps/api/js?sensor=false')

  body
    h1 bug swarm fleetwatcher
    #dashboard
      #map_canvas
      #sidebar
        ul#swarms
          li#swarm_1.alive swarm_1 (alive)
            ul
              li#resource_1.dead  resource_1 (dead)
              li#resource_2.alive resource_2 (alive)
          li#swarm_2.dead swarm_2 (dead)
            ul
              li#resource_3.alive resource_3 (alive)
              li#resource_4.dead  resource_4 (dead)

    :coffeescript
      window.initialize = ->
        buglabs = { lat: 40.72498216901785, lon: -73.99708271026611 }

        console.log 'creating socketio server'

        try
          socket = io.connect 'http://api.bugswarm-dev'
        catch e
          console.log 'exception: ' + e

        socket.on 'connect', ->
          socket.emit 'apikey', '58528a20ff7b4e08f71213cfbe22daffd8c3b3d3'

        socket.on 'message', (message) ->
          console.log "MESSAGE: #{JSON.parse message?.message}"
          updateResource JSON.parse message?.message?.body?.data

        socket.on 'connected to backend', ->
          console.log 'connected'
          socket.emit 'message', { presence: { to: '59c8f62e210812de2937d4700b6f751400546694@swarms.xmpp.bugswarm-dev/browser' } }
        socket.on 'presence', (who) ->
          console.log "PRESENCE: #{who}"
          who = who.from.split('@')[0]
          alive = who.type is 'available'

          list_element = $ "##{who}" || $('#seen').append "<li id=#{who} class='resource' >#{who}</li>"

          list_element.attr class: (alive? 'alive': 'dead')

        console.log 'creating map centered around BUG Labs'
        mapOptions = zoom: 12, center: new google.maps.LatLng(buglabs.lat, buglabs.lon) , mapTypeId: google.maps.MapTypeId.ROADMAP
        mapCanvas = document.getElementById "map_canvas"
        mapGoogle = new google.maps.Map mapCanvas, mapOptions

        markers = []

        updateResource = (resource) ->
          console.log swarm = resource.body?.from.split('@')[0]
          console.log m_swarm = resource.body?.from.split('/')[1]

          marker = new google.maps.Marker
            position: new google.maps.LatLng resource.body?.latitude, resource.body?.longitude
            icon: "http://robohash.org/#{resource.body?.id}.png?size=40x40&set=set3"
            map: mapGoogle
            html: "<strong>#{resource.body?.mpg}</strong>"
            title: resource.body?.name

          google.maps.event.addListener marker, 'click', () ->
            car = $ "##{resource.body?.id}" || $("#{resource.body?.from.split('/')[1]}").append resource
            car.parent.expand
            car.highlight

          markers.push marker

    script(type='text/javascript')
      window.initialize()
