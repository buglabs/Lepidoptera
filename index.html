<!DOCTYPE html>  <html> <head>   <title>server.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h3>Lepidoptera</h3>

<p><strong>Lepidoptera</strong> is an example solution built on top of <a href="http://github.com/buglabs/swarm">Swarm</a>.</p>

<p>It is a visualization of fleet movement that can help to quickly
identify and answer high level questions like</p>

<ul>
<li>how many people are sleeping?</li>
<li>which drivers are the most efficient?</li>
<li><p>are there any areas that are more difficult to get to?</p>

<p>etc...</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>Installation</h3>

<p>To get Lepidoptera up and running, first make sure you have
<a href="http://nodejs.org/">Node.js</a> (<code>brew install node</code>) and
<a href="http://npmjs.org">npm</a> (<code>curl http://npmjs.org/install.sh | sh</code>).
Then, just:</p>

<pre><code>npm install
npm install supervisor -g
supervisor src/*coffee
</code></pre>

<p>Now browse <code>http://localhost/locations</code> to witness the magic</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Server</h3>

<p>The webserver keeps a lightweight model of the swarm in memory, and is responsible
for passing any important messages and events to the frontend when rendering.</p>

<p>In addition, this server supports populating swarms with fake data</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">express = </span><span class="nx">require</span> <span class="s1">&#39;express&#39;</span>
<span class="nv">app = </span><span class="nx">express</span><span class="p">.</span><span class="nx">createServer</span><span class="p">()</span>
<span class="nv">jade = </span><span class="nx">require</span> <span class="s1">&#39;jade&#39;</span>
<span class="nv">http = </span><span class="nx">require</span> <span class="s1">&#39;http&#39;</span>
<span class="nv">request = </span><span class="nx">require</span> <span class="s1">&#39;request&#39;</span>

<span class="nv">host = </span><span class="s1">&#39;api.bugswarm-dev&#39;</span>
<span class="nv">header = </span><span class="p">{</span> <span class="s1">&#39;X-BugSwarmApiKey&#39;</span><span class="o">:</span> <span class="s1">&#39;58528a20ff7b4e08f71213cfbe22daffd8c3b3d3&#39;</span> <span class="p">}</span>

<span class="nv">buglabs = </span><span class="p">{</span> <span class="nv">lat: </span><span class="mf">40.72498216901785</span><span class="p">,</span> <span class="nv">lon: </span><span class="o">-</span><span class="mf">73.99708271026611</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The internal swarm model contains a name, unique id and most importantly a handle to the stream</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">swarms = </span><span class="p">[]</span>
<span class="nx">swarms</span><span class="p">.</span><span class="nx">push</span>
  <span class="nv">id: </span><span class="s1">&#39;59c8f62e210812de2937d4700b6f751400546694&#39;</span>
  <span class="nv">name: </span><span class="s1">&#39;fake&#39;</span>
  <span class="nv">stream: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3>Routing / API</h3>

<p>To push your own location data, use <code>put /location/:swarm_id</code> with
latitude and longitude in the request.
The server also supports a get request in the form of
<code>get /location/:swarm/:latitude/:longitude</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">put</span> <span class="s1">&#39;/location/:swarm_id&#39;</span><span class="p">,</span> <span class="nf">(req,res) -&gt;</span>
  <span class="nx">sendLocation</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">swarm_id</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">longitude</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;/location/:swarm_id/:latitude,:longitude&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
  <span class="nx">sendLocation</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">swarm_id</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">longitude</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>To see a map of all the location feeds, <code>get /locations</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;/locations&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
  <span class="nx">watchMap</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h3>Helper Methods</h3>

<p><strong>sendLocation</strong> pushes out a new location to a swarm</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">sendLocation = </span><span class="nf">(swarm_id, latitude, longitude) -&gt;</span>
  <span class="nv">swarm = </span><span class="nx">swarms</span><span class="p">[</span><span class="nx">id</span><span class="o">=</span><span class="nx">swarm_id</span><span class="p">]</span>
  <span class="nx">swarm</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">write</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="p">{</span> <span class="nv">name: </span><span class="nx">swarm</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nv">latitude: </span><span class="nx">latitude</span><span class="p">,</span> <span class="nv">longitude: </span><span class="nx">longitude</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><strong>openLocationFeed</strong> starts the connection for each swarm stream if necessary.
A bonus feature, if your swarm name contains the word <code>fake</code> the server will start generating random data!</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">openLocationFeed = </span><span class="o">-&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;opening location feed&#39;</span>

  <span class="k">for</span> <span class="nx">swarm</span> <span class="k">in</span> <span class="nx">swarms</span>
    <span class="nx">swarm</span><span class="p">.</span><span class="nx">stream</span> <span class="o">?=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">put</span>
      <span class="nv">uri: </span><span class="s2">&quot;http://#{host}/resources/producer1/feeds/location?swarm_id=#{swarm.id}&quot;</span>
      <span class="nv">headers: </span><span class="nx">header</span>
      <span class="nf">(error, response, body) -&gt;</span>
        <span class="nx">swarm</span><span class="p">.</span><span class="nx">stream</span><span class="p">.</span><span class="nx">write</span> <span class="s1">&#39;\n&#39;</span>
        <span class="k">if</span> <span class="nx">swarm</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">contains</span> <span class="s1">&#39;fake&#39;</span>
          <span class="nx">startFakeStream</span> <span class="nx">swarm</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><strong>startFakeStream</strong> pushes out fake locations to a swarm every few seconds</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">startFakeStream = </span><span class="nf">(swarm) -&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;Starting fake stream for &#39;</span> <span class="o">+</span> <span class="nx">swarm</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; swarm&#39;</span>
  <span class="nv">size = </span><span class="p">.</span><span class="mi">25</span>
  <span class="nv">lat = </span><span class="nx">buglabs</span><span class="p">.</span><span class="nx">lat</span> <span class="o">-</span> <span class="nx">size</span> <span class="err">/ 2</span>
  <span class="nv">lon = </span><span class="nx">buglabs</span><span class="p">.</span><span class="nx">lon</span> <span class="o">-</span> <span class="nx">size</span> <span class="err">/ 2</span>

  <span class="nx">setInterval</span> <span class="o">-&gt;</span>
    <span class="nx">sendLocation</span> <span class="nx">swarm</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">lat</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">lon</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">size</span>
  <span class="p">,</span> <span class="mi">5000</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><strong>watchMap</strong> renders the frontend, displaying markers for each new location
sent to a swarm <strong>since the page was opened</strong></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">watchMap = </span><span class="nf">(req, res) -&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;setting up keepalive connection&#39;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;Content-Type&quot;</span><span class="o">:</span> <span class="s2">&quot;text/html&quot;</span>
  <span class="nx">setInterval</span> <span class="p">(</span> <span class="o">-&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="s1">&#39;\n&#39;</span><span class="p">),</span> <span class="mi">30000</span>

  <span class="nx">jade</span><span class="p">.</span><span class="nx">renderFile</span> <span class="s1">&#39;map.jade&#39;</span><span class="p">,</span> <span class="nf">(error, html) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;rendering jade&#39;</span>

    <span class="k">if</span> <span class="nx">error</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s1">&#39;error rendering jade&#39;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="nx">error</span>
    <span class="k">else</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">write</span> <span class="nx">html</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">static</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/public&#39;</span><span class="p">)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">app</span><span class="p">.</span><span class="nx">router</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span> <span class="mi">80</span>

<span class="nx">openLocationFeed</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 